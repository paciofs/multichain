os: osx
osx_image: xcode10.1

language: cpp

addons:
  homebrew:
    packages:
      - autoconf
      - automake
      - berkeley-db4
      - boost
      - ccache
      - libtool
      - openssl
      - pkg-config
      - rename

install:
  # it is insufficient to only install boost@1.57 in the first place
  # reinstallation is necessary for some reason
  - brew uninstall --ignore-dependencies boost
  - brew install boost@1.57
  - brew link boost@1.57 --force

  # hide dynamic libraries from the build system so we get a static build
  - rename -e 's/.dylib/.dylib.hidden/' /usr/local/opt/boost/lib/*.dylib
  - rename -e 's/.dylib/.dylib.hidden/' /usr/local/opt/berkeley-db@4/lib/*.dylib

  # reinstall OpenSSL, but with static libraries only
  - sed -i '' 's/^    shared$/    no-shared/' /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula/openssl.rb
  - brew reinstall openssl --build-from-source
  - export CPPFLAGS=-I/usr/local/opt/openssl/include
  - export LDFLAGS=-L/usr/local/opt/openssl/lib

  # disable all warnings to reduce build verbosity
  - export CXXFLAGS=-w
  - ./autogen.sh
  - ./configure --with-gui=no --with-libs=no --with-miniupnpc=no --with-boost=/usr/local/opt/boost@1.57
  - make -j2

script:
  # tiny test
  - mkdir /tmp/mc-test
  - ./src/multichain-util create test 10011 -datadir=/tmp/mc-test -rpcpassword=rpcpass
  - ./src/multichaind test 10011 -daemon -datadir=/tmp/mc-test -pid=/tmp/mc-test/test/multichain.pid
  - ./src/multichain-cli test -datadir=/tmp/mc-test getblockchaininfo
  - kill $(< /tmp/mc-test/test/multichain.pid)

before_deploy:
  # figure out date of last upstream commit to this branch
  - LAST_MERGE=$(git log --merges --max-count=1 ${TRAVIS_BRANCH} --format=%ad)
  - LAST_UPSTREAM=$(git log --before="${LAST_MERGE}" --skip=1 --max-count=1 --format=%ai ${TRAVIS_BRANCH})
  - LAST_UPSTREAM=$(TZ=UTC date -j -f "%Y-%m-%d %H:%M:%S %z" "${LAST_UPSTREAM}" "+%Y%m%dT%H%M%S")

  # pack binaries
  - mkdir multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}
  - cp ./src/multichain-cli ./multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}
  - cp ./src/multichain-util ./multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}
  - cp ./src/multichaind ./multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}
  - cp ./src/multichaind-cold ./multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}
  - tar czf multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}-${LAST_UPSTREAM}.tar.gz ./multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}

  # this names the deployed tag
  - export TRAVIS_TAG=${TRAVIS_BRANCH}

deploy:
  # deploy as GitHub release
  provider: releases
  # unencrypted GitHub OAuth token, generated using `travis setup releases` and set in Travis settings
  # this means you have to answer `no` when prompted whether to encrypt the API key
  # instead, add an environment variable `GITHUB_OAUTH_TOKEN` to your repository settings in Travis,
  # and select its value not to be displayed in the build log
  api_key: ${GITHUB_OAUTH_TOKEN}
  file: ./multichain-${TRAVIS_BRANCH}-${TRAVIS_OS_NAME}-${LAST_UPSTREAM}.tar.gz
  skip_cleanup: true
  overwrite: true
  on:
    repo: ${TRAVIS_REPO_SLUG}
    branch: ${TRAVIS_BRANCH}
    tags: false
